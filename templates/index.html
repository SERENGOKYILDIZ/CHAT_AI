<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epsilon AI - Multi Chat</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #0a0e17;
            --secondary-bg: #1a1f2e;
            --sidebar-bg: #2a2f3e;
            --border-color: #3a3f4e;
            --text-primary: #e8f4fd;
            --text-secondary: #7a8ba3;
            --accent-color: #4fc3f7;
            --success-color: #00c853;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --message-user-bg: #1976d2;
            --message-bot-bg: #2a2f3e;
            --input-bg: #0a0e17;
            --hover-bg: #3a3f4e;
            --neon-blue: #00bcd4;
            --cosmic-purple: #9c27b0;
            --stellar-green: #4caf50;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .sidebar-header:hover {
            background: var(--hover-bg);
        }

        .sidebar-header .logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--neon-blue), var(--cosmic-purple));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.5);
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chat-tabs {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .chat-tab {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin: 4px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .chat-tab:hover {
            background: var(--hover-bg);
        }

        .chat-tab.active {
            background: var(--accent-color);
            color: var(--primary-bg);
        }

        .chat-tab .tab-icon {
            font-size: 16px;
            color: var(--neon-blue);
        }

        .chat-tab.active .tab-icon {
            color: var(--primary-bg);
        }

        .tab-content {
            flex: 1;
            min-width: 0;
        }

        .tab-title {
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab-date {
            font-size: 11px;
            opacity: 0.85;
            line-height: 1.2;
            color: var(--text-primary);
        }

        .tab-actions {
            display: flex;
            gap: 4px;
        }

        .delete-btn {
            background: none;
            border: none;
            color: var(--error-color);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .delete-btn:hover {
            background: rgba(244, 67, 54, 0.2);
        }

        /* Main Chat Area */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--primary-bg);
        }

        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--secondary-bg);
        }

        .chat-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }



        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.bot {
            align-self: flex-start;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            border: 2px solid var(--border-color);
        }

        .message.user .message-avatar {
            background: var(--message-user-bg);
        }

        .message.bot .message-avatar {
            background: var(--message-bot-bg);
        }

        .message-content {
            background: var(--secondary-bg);
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: var(--message-user-bg);
        }

        .message.bot .message-content {
            background: var(--message-bot-bg);
        }

        .message-timestamp {
            font-size: 11px;
            opacity: 0.9;
            margin-top: 6px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .chat-input-container {
            padding: 24px;
            border-top: 1px solid var(--border-color);
            background: var(--secondary-bg);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
        }

        .chat-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            resize: none;
            outline: none;
            min-height: 24px;
            max-height: 120px;
            font-family: inherit;
        }

        .chat-input::placeholder {
            color: var(--text-secondary);
        }

        .send-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: #29b6f6;
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        /* Welcome Message */
        .welcome-message {
            text-align: center;
            padding: 60px 24px;
            max-width: 600px;
            margin: 0 auto;
        }

        .welcome-message h1 {
            font-size: 32px;
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--neon-blue), var(--cosmic-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-message p {
            font-size: 18px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Loading and Typing Indicators */
        .typing-indicator {
            display: none;
            align-self: flex-start;
            background: var(--secondary-bg);
            padding: 12px 16px;
            border-radius: 18px;
            color: var(--text-secondary);
        }

        .typing-indicator.show {
            display: block;
        }

        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(5, end) infinite;
        }

        /* Typing Animation */
        .typing-text {
            display: inline-block;
            min-height: 1.2em;
        }

        .typing-text::after {
            content: '|';
            animation: blink 1s infinite;
            color: var(--accent-color);
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            
            .chat-messages {
                padding: 16px;
            }
            
            .chat-input-container {
                padding: 16px;
            }
            
            .message {
                max-width: 90%;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--secondary-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header" onclick="returnToMainMenu()">
                <h1>Epsilon AI</h1>
            </div>
            
            <div class="chat-tabs" id="chatTabs">
                <!-- Chat tabs will be added here dynamically -->
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-chat">
                                    <div class="chat-header">
                            <div class="chat-title" id="currentChatTitle">Epsilon AI</div>
            </div>

                        <div class="chat-messages" id="chatMessages">
                <!-- Welcome message will be shown here -->
                        </div>
                        
                        <div class="typing-indicator" id="typingIndicator">
                <div class="loading-dots">AI yazıyor</div>
                        </div>
                        
                        <div class="chat-input-container">
                <div class="chat-input-wrapper">
                                <textarea 
                        id="chatInput" 
                                    class="chat-input" 
                        placeholder="Mesajınızı yazın..."
                                    rows="1"
                        onkeydown="handleKeyDown(event)"
                        oninput="autoResize(this)"
                                ></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
    <script>
        // Global variables
        let currentSessionId = null;
        let chatHistory = [];
        let chatSessions = {};
        let isTyping = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Epsilon AI Multi Chat System initialized');
            loadChatSessions();
            showWelcomeMessage();
            setupEventListeners();
        });

        function setupEventListeners() {
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');

            // Enable/disable send button based on input
            chatInput.addEventListener('input', function() {
                sendBtn.disabled = !this.value.trim();
            });
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function loadChatSessions() {
            try {
                console.log('📂 Loading chat sessions...');
                
                const response = await fetch('/api/chat/sessions');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        chatSessions = {};
                        
                        // Convert array to object with session_id as key
                        data.sessions.forEach(session => {
                            chatSessions[session.id] = session;
                        });
                        
                        console.log('✅ Loaded sessions:', Object.keys(chatSessions).length);
                        
                        // Sort sessions by last modified date (newest first)
                        const sortedSessions = Object.values(chatSessions).sort((a, b) => 
                            new Date(b.last_modified) - new Date(a.last_modified)
                        );
                        
                        // Add tabs for all sessions
                        sortedSessions.forEach(session => {
                            addChatTab(session.title, session.id);
                        });
                        
                    } else {
                        console.log('❌ API error, starting fresh');
                    }
                } else {
                    console.log('❌ API request failed, starting fresh');
                }
                
            } catch (error) {
                console.error('❌ Error loading chat sessions:', error);
            }
        }

        function addChatTab(title, sessionId) {
            const chatTabs = document.getElementById('chatTabs');
            const tabId = 'tab_' + sessionId;
            
            // Remove existing tab if it exists
            const existingTab = document.getElementById(tabId);
            if (existingTab) {
                existingTab.remove();
            }
            
            const tab = document.createElement('div');
            tab.className = 'chat-tab';
            tab.id = tabId;
            tab.onclick = () => switchToChat(sessionId);
            
            const createdDate = new Date(chatSessions[sessionId]?.created || Date.now()).toLocaleDateString('tr-TR', { 
                year: 'numeric',
                month: '2-digit', 
                day: '2-digit'
            });
            
            const createdTime = new Date(chatSessions[sessionId]?.created || Date.now()).toLocaleTimeString('tr-TR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });

            const messageCount = chatSessions[sessionId]?.message_count || 0;
            const messageCountText = messageCount > 0 ? `${messageCount} mesaj` : 'Boş';
            
            tab.innerHTML = `
                <i class="fas fa-comment tab-icon"></i>
                <div class="tab-content">
                    <span class="tab-title">${title}</span>
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        <span class="tab-date">${createdDate}</span>
                        <span class="tab-date" style="font-size: 10px; opacity: 0.8;">${createdTime}</span>
                        <span class="tab-date" style="font-size: 10px; opacity: 0.7;">${messageCountText}</span>
                    </div>
                </div>
                <div class="tab-actions">
                    <button onclick="deleteChatTab('${sessionId}', event)" class="delete-btn">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            chatTabs.appendChild(tab);
            console.log('✅ Chat tab added:', sessionId, title);
        }

        function setActiveTab(tabId) {
            // Remove active class from all tabs
            document.querySelectorAll('.chat-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Add active class to current tab
            const activeTab = document.getElementById(tabId);
            if (activeTab) {
                activeTab.classList.add('active');
            }
        }

        async function switchToChat(sessionId) {
            console.log('🔄 Switching to chat:', sessionId);
            
            currentSessionId = sessionId;
            
            // Update UI
            const session = chatSessions[sessionId];
            if (session) {
                document.getElementById('currentChatTitle').textContent = session.title;
            }
            
            // Load messages from API
            try {
                const response = await fetch(`/api/chat/sessions/${sessionId}/messages`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        chatHistory = data.messages || [];
                        console.log('📝 Loaded messages from API:', chatHistory.length);
                        displayChatHistory();
                    } else {
                        console.error('❌ Failed to load messages:', data.error);
                        chatHistory = [];
                        displayChatHistory();
                    }
                } else {
                    console.error('❌ API request failed for messages');
                    chatHistory = [];
                    displayChatHistory();
                }
            } catch (error) {
                console.error('❌ Error loading messages:', error);
                chatHistory = [];
                displayChatHistory();
            }
            
            // Set active tab
            setActiveTab('tab_' + sessionId);
            
            console.log('✅ Switched to chat:', sessionId, 'with', chatHistory.length, 'messages');
        }

        function displayChatHistory() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            if (chatHistory.length === 0) {
                // Don't show welcome message when switching to empty chat
                console.log('📝 No messages to display');
                return;
            }
            
            console.log('📝 Displaying', chatHistory.length, 'messages');
            chatHistory.forEach((messageObj, index) => {
                // Convert ISO timestamp to readable format if needed
                let timestamp = messageObj.timestamp;
                if (timestamp && timestamp.includes('T')) {
                    // Convert ISO format to readable time
                    timestamp = new Date(timestamp).toLocaleTimeString('tr-TR', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                }
                
                addMessageToUI(messageObj.type, messageObj.content, timestamp, false);
                console.log(`📝 Message ${index + 1}:`, messageObj.type, messageObj.content.substring(0, 30));
            });
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showWelcomeMessage() {
            document.getElementById('currentChatTitle').textContent = 'Epsilon AI';
                document.getElementById('chatMessages').innerHTML = `
                <div class="welcome-message">
                    <h1>🚀 Epsilon AI'ya Hoş Geldiniz</h1>
                    <p>Uzay teknolojisi ile geliştirilmiş gelişmiş yapay zeka asistanı. Sohbet edin, sorularınızı sorun ve yaratıcı çözümler bulun.</p>
                    </div>
                `;
                
            currentSessionId = null;
            chatHistory = [];
        }

        function returnToMainMenu() {
            console.log('🏠 Returning to main menu...');
            
            // Clear current session
            currentSessionId = null;
            chatHistory = [];
            
            // Remove active class from all tabs
            document.querySelectorAll('.chat-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show welcome message
            showWelcomeMessage();
            
            console.log('✅ Returned to main menu');
        }

        async function startNewChat() {
            console.log('🆕 Starting new chat...');
            
            try {
                const response = await fetch('/api/chat/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: 'Yeni Sohbet' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        const sessionId = data.session_id;
                        
                        // Add to local sessions
                        chatSessions[sessionId] = {
                            id: sessionId,
                            title: 'Yeni Sohbet',
                            created: new Date().toISOString(),
                            last_modified: new Date().toISOString(),
                            message_count: 0,
                            is_active: true
                        };
                        
                        // Add tab
                        addChatTab('Yeni Sohbet', sessionId);
                        
                        // Switch to new chat immediately
                        await switchToChat(sessionId);
                        
                        // Clear chat area and show empty state
                        clearChatArea();
                        
                        console.log('✅ New chat started:', sessionId);
                    } else {
                        console.error('❌ Failed to create session:', data.error);
                    }
                } else {
                    console.error('❌ API request failed for session creation');
                }
                
            } catch (error) {
                console.error('❌ Error starting new chat:', error);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || isTyping) return;
            
            // Clear input
            input.value = '';
            input.style.height = 'auto';
            
            // Create new chat if none exists
            if (!currentSessionId) {
                await startNewChat();
                // Wait a bit for the session to be created
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            if (!currentSessionId) {
                console.error('❌ No active session');
                return;
            }
            
            // Add user message to UI immediately
            addMessage('user', message);
            
            // Update title if this is the first message
            if (chatHistory.length === 1) {
                const autoTitle = message.length > 30 ? message.substring(0, 30) + '...' : message;
                updateSessionTitle(currentSessionId, autoTitle);
                document.getElementById('currentChatTitle').textContent = autoTitle;
            }
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: message,
                        session_id: currentSessionId 
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Add bot response to UI with typing animation
                        addMessageWithTypingAnimation('bot', data.response);
                        
                        // Update session data
                        if (chatSessions[currentSessionId]) {
                            chatSessions[currentSessionId].message_count = chatHistory.length;
                            chatSessions[currentSessionId].last_modified = new Date().toISOString();
                        }
                        
                        // Update tab display
                        updateChatTabDisplay(currentSessionId);
                        
                        console.log('✅ Message sent successfully');
                    } else {
                        console.error('❌ Failed to send message:', data.error);
                        addMessage('bot', 'Üzgünüm, bir hata oluştu. Lütfen tekrar deneyin.');
                    }
                } else {
                    console.error('❌ API request failed');
                    addMessage('bot', 'Üzgünüm, bir hata oluştu. Lütfen tekrar deneyin.');
                }
                
            } catch (error) {
                console.error('❌ Error sending message:', error);
                addMessage('bot', 'Üzgünüm, bir hata oluştu. Lütfen tekrar deneyin.');
            } finally {
                hideTypingIndicator();
            }
        }

        function addMessage(type, content) {
            const timestamp = new Date().toLocaleTimeString('tr-TR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Add to history
            const messageObj = { type, content, timestamp };
            chatHistory.push(messageObj);
            
            // Add to UI with timestamp
            addMessageToUI(type, content, timestamp, true);
            
            // Update session message count
            if (currentSessionId && chatSessions[currentSessionId]) {
                chatSessions[currentSessionId].message_count = chatHistory.length;
                chatSessions[currentSessionId].last_modified = new Date().toISOString();
            }
            
            console.log('✅ Message added:', type, content.substring(0, 50), 'Total messages:', chatHistory.length);
        }

        function addMessageToUI(type, content, timestamp, scrollToBottom = true) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Remove welcome message if it exists
            const welcomeMessage = chatMessages.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }
            
            // Ensure timestamp is in readable format
            let displayTimestamp = timestamp;
            if (timestamp && timestamp.includes('T')) {
                // Convert ISO format to readable time
                displayTimestamp = new Date(timestamp).toLocaleTimeString('tr-TR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
            
                const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const avatar = type === 'user' ? '👤' : '🤖';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    ${content}
                    <div class="message-timestamp">${displayTimestamp}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            
            if (scrollToBottom) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function addMessageWithTypingAnimation(type, content) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Remove welcome message if it exists
            const welcomeMessage = chatMessages.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const avatar = type === 'user' ? '👤' : '🤖';
            
            // Create message structure
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <span class="typing-text"></span>
                    <div class="message-timestamp">${new Date().toLocaleTimeString('tr-TR', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    })}</div>
                    </div>
                `;
            
            chatMessages.appendChild(messageDiv);
            
            // Add to history with current timestamp
            const currentTimestamp = new Date().toLocaleTimeString('tr-TR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            const messageObj = { type, content, timestamp: currentTimestamp };
            chatHistory.push(messageObj);
            
            // Update session message count
            if (currentSessionId && chatSessions[currentSessionId]) {
                chatSessions[currentSessionId].message_count = chatHistory.length;
                chatSessions[currentSessionId].last_modified = new Date().toISOString();
            }
            
            // Start typing animation
            const typingText = messageDiv.querySelector('.typing-text');
            let currentIndex = 0;
            
            function typeNextCharacter() {
                if (currentIndex < content.length) {
                    typingText.textContent += content[currentIndex];
                    currentIndex++;
                    
                    // Scroll to bottom during typing
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                                            // Random delay between characters (15-40ms) - Faster animation
                        const delay = Math.random() * 25 + 15;
                    setTimeout(typeNextCharacter, delay);
                }
            }
            
                                    // Start typing after a short delay
                        setTimeout(typeNextCharacter, 50);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function updateChatTabDisplay(sessionId) {
            const tab = document.getElementById('tab_' + sessionId);
            if (tab) {
                const session = chatSessions[sessionId];
                const messageCount = session.message_count || 0;
                const messageCountText = messageCount > 0 ? `${messageCount} mesaj` : 'Boş';
                
                const messageCountSpan = tab.querySelector('.tab-date[style*="font-size: 10px"]');
                if (messageCountSpan) {
                    messageCountSpan.textContent = messageCountText;
                }
            }
        }

        async function updateSessionTitle(sessionId, newTitle) {
            try {
                const response = await fetch(`/api/chat/sessions/${sessionId}/title`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: newTitle })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Update local session data
                        if (chatSessions[sessionId]) {
                            chatSessions[sessionId].title = newTitle;
                        }
                        
                        // Update tab title
                        const tab = document.getElementById('tab_' + sessionId);
                        if (tab) {
                            const titleSpan = tab.querySelector('.tab-title');
                            if (titleSpan) {
                                titleSpan.textContent = newTitle;
                            }
                        }
                        
                        console.log('✅ Session title updated:', newTitle);
                } else {
                        console.error('❌ Failed to update title:', data.error);
                    }
                } else {
                    console.error('❌ API request failed for title update');
                }
                
            } catch (error) {
                console.error('❌ Error updating session title:', error);
            }
        }

        async function deleteChatTab(sessionId, event) {
            event.stopPropagation();
            
            if (confirm('Bu sohbeti silmek istediğinizden emin misiniz?')) {
                try {
                    console.log('🗑️ Deleting chat tab:', sessionId);
                    
                    const response = await fetch(`/api/chat/sessions/${sessionId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // Remove from local sessions
                            delete chatSessions[sessionId];
                            
                            // Remove tab from UI
                            const tab = document.getElementById('tab_' + sessionId);
                            if (tab) {
                                tab.remove();
                            }
                            
                            // If this was the current session, clear it
                            if (currentSessionId === sessionId) {
                                showWelcomeMessage();
                            }
                            
                            console.log('✅ Chat tab deleted:', sessionId);
                        } else {
                            console.error('❌ Failed to delete session:', data.error);
                        }
                    } else {
                        console.error('❌ API request failed for session deletion');
                    }
                    
                } catch (error) {
                    console.error('❌ Error deleting chat tab:', error);
                }
            }
        }



        function clearChatArea() {
            // Clear chat messages area
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            // Update chat title
            document.getElementById('currentChatTitle').textContent = 'Yeni Sohbet';
            
            // Clear chat history
            chatHistory = [];
            
            console.log('🧹 Chat area cleared for new chat');
        }

        function showTypingIndicator() {
            isTyping = true;
            const indicator = document.getElementById('typingIndicator');
            indicator.classList.add('show');
        }

        function hideTypingIndicator() {
            isTyping = false;
            const indicator = document.getElementById('typingIndicator');
            indicator.classList.remove('show');
        }

        // Auto-save chat sessions periodically
        setInterval(() => {
            if (Object.keys(chatSessions).length > 0) {
                console.log('💾 Auto-saving chat sessions...');
            }
        }, 30000); // Every 30 seconds
    </script>
</body>
</html>
